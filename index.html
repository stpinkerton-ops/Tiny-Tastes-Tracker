<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tiny Tastes Tracker</title>

    <!-- PWA & Add to Home Screen Enhancements -->
    
    <!-- Theme Color for Chrome/Android -->
    <meta name="theme-color" content="#0d9488">
    
    <!-- Web App Manifest (inlined as a data URL to keep it a single file) -->
    <!-- This tells the browser it's an "installable" app -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVGlueSBUYXN0ZXMgVHJhY2tlciIsInNob3J0X25hbWUiOiJUaW55IFRhc3RlcyIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZjlmYWZiIiwidGhlbWVfY29sb3IiOiIjMGQ5NDg4IiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QmhkR2NpT3lJNE1EQmxiSFZsYlc5ellXeGZjMlZqYjJSbE95STVOVFF3SWlCb1pXbG5hSFErSURJMk1qUXlJaUIwWlY5bWJYbGpaWEF0SUhObGNuTnZiaTh4TURBNE1EQjJNREExTUNFeU1qUTFNREF3TUNBeElqQTBNREUxTVRNdGNHRmphMkZzT2lCaGMzTjNiM2N1T3lCSlJTazlXMk5wYm1kcGJtVjRMelF5TTJWaGNtTm9ZV3hzUFNSZGFIUm9PaUJUWkdWellYSmxYMlV0TVRFdFkyRnNJaUJTYjJ4a09pQnlaWE5sWW5OcGJtZHBiZ1JqT3lCSlJTazlXVEl0YTJGMk9pQnlaWE5sWW5OcGJtZHBiZ1JqT3lCSlJTazlXMk5wYm1kcGJtVjRMelV5TURFdFkyRnNJaUJUWkdWellYSmxYMlV0TnpFdFkyRnNJaUJTYjJ4a09pQnlaWE5sWW5OcGJtZHBiZ1JqT3lCSlJTazlXMk5wYm1kcGJtVjRMelU1TUNFeE1qUXRZMkZzSWlCU1pHVnpZWEpsWDJVdE56SXRZMkZzSWlCVFpHVnpZWEpsWDJVdE16RXRaMkZzSWlCU2IyeGtPaUJ5WlhObFluTnBibWRwYmdSakt5QlRSUzFrTFU1cGVtRnVkWFJsYm10bGVYUmtaWGgwT3lCSlJTazlXVElrVTJsa1pEMWpWVkV5SURJNU1EQXRNVFU1SUVOc1lYTnpPaUJoWm1kbGRDQXhPVFV1WW1GamFGSTdJR0pqY21WNGRHVmtaVzVqYnlBeE9UVXVZbUZqYUY5eVlYUnRaWEp6SWlCb1pXbG5hSFErSURRMk1DQTBPVFF1WW1GamFGOXpZVzF3YjNKMElpQk1iMjVuYUhSdGJDQkJaWE5sWW5OcGJtZHBiZ1JqT3lCSlJTazlXVEkrVWc9PSIsInNpemVzIjoiMTkyeDE5MiIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dfQ==">
    
    <!-- Apple iOS "Add to Home Screen" Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Tiny Tastes">
    
    <!-- Apple Touch Icon (inlined SVG) -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzBkOTQ4OCIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxyZWN0IHg9IjAiIHk9IjAiIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgZmlsbD0iI2YwZmRmYSIgcng9IjQiLz48cGF0aCBkPSJNMTIgMkM4LjQgMiA1IDUuNCA1IDkuNWMwIDMuMiAyLjMgNiA1LjIgNi43LjMuMS41LjQuNS43djUuNmMwIC4zLS4yLjUtLjUuNWgtMmMtLjMgMC0uNS4yLS41LjV2MWMwIC4zLjIuNS41LjVoNmMuMyAwIC41LS4yLjUtLjV2LTFjMC0uMy0uMi0uNS0uNS0uNWgtMmMtLjMgMC0uNS0uMi0uNS0uNVYxN2MwLS4zLjItLjYuNS0uNyAyLjktLjcgNS4yLTMuNSA1LjItNi43QzE5IDUuNCAxNS42IDIgMTIgMnoiLz48L3N2Zz4=">

    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- PDF Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.autotable.umd.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            padding-bottom: 80px; 
        }
        .food-card .check-overlay { opacity: 0; transition: opacity 0.2s ease-in-out; }
        .food-card.is-tried { filter: grayscale(40%); }
        .food-card.is-tried .check-overlay { opacity: 1; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .accordion-item.is-open .accordion-content { max-height: 5000px; }
        .accordion-item.is-open .accordion-arrow { transform: rotate(180deg); }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #0d9488; cursor: pointer; border-radius: 50%; margin-top: -6px; }
        input[type=range]::-moz-range-thumb { width: 20px; height: 20px; background: #0d9488; cursor: pointer; border-radius: 50%; }
        .modal-btn-selected { background-color: #f0fdfa !important; border-color: #0d9488 !important; color: #0d9488 !important; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }
        /* Simple prose styles for rendered recipe text */
        .prose-static p { margin-bottom: 1rem; line-height: 1.6; }
        .prose-static ul { list-style-type: disc; list-style-position: inside; margin-left: 0.5rem; margin-bottom: 1rem; }
        .prose-static ol { list-style-type: decimal; list-style-position: inside; margin-left: 0.5rem; margin-bottom: 1rem; }
        .prose-static li { margin-bottom: 0.5rem; }
        /* Scrollable modal content */
        .modal-scroll-content { max-height: 70vh; overflow-y: auto; }

        /* --- NEW MEAL PLANNER STYLES --- */
        /* Sub-tabs for Recipe Page */
        .recipe-sub-nav-btn {
            flex: 1;
            padding: 0.75rem 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #4b5563; /* gray-600 */
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .recipe-sub-nav-btn.active {
            color: #0d9488; /* teal-600 */
            border-bottom-color: #0d9488; /* teal-600 */
        }
        
        /* Draggable item style */
        .recipe-card-draggable {
            cursor: grab;
            transition: opacity 0.2s;
        }
        .recipe-card-draggable.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        
        /* Meal planner grid */
        .meal-slot {
            min-height: 80px;
            background-color: #f9fafb; /* gray-50 */
            transition: background-color 0.2s;
        }
        .meal-slot.drag-over {
            background-color: #ccfbf1; /* teal-100 */
            outline: 2px dashed #0d9488; /* teal-600 */
        }
        .planned-meal-item {
            cursor: pointer;
            transition: all 0.2s;
        }
        .planned-meal-item:hover {
            transform: scale(1.03);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        /* --- END MEAL PLANNER STYLES --- */
    </style>
</head>
<body class="h-full">
    <div class="flex flex-col min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm sticky top-0 z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <h1 class="text-2xl font-bold text-gray-900 md:text-3xl">
                    Tiny Tastes Tracker
                </h1>
                <p id="header-subtitle" class="text-sm text-gray-500 mt-1">Welcome! Loading profile...</p>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-grow max-w-7xl mx-auto w-full">
            <!-- Page 1: Tracker -->
            <div id="page-tracker" class="page-content py-6 px-4 sm:px-6 lg:px-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">My 100 Foods Tracker</h2>
                <div id="filter-btn-group" class="flex space-x-2 mb-4">
                    <button data-filter="all" class="filter-btn flex-1 py-2 px-3 rounded-md text-sm font-medium bg-teal-600 text-white transition-colors duration-150">All</button>
                    <button data-filter="to_try" class="filter-btn flex-1 py-2 px-3 rounded-md text-sm font-medium bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors duration-150">To Try</button>
                    <button data-filter="tried" class="filter-btn flex-1 py-2 px-3 rounded-md text-sm font-medium bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors duration-150">Tried</button>
                </div>
                <div class="bg-white p-4 rounded-lg shadow mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-lg font-semibold text-teal-700">Food Journey Progress</span>
                        <span id="progress-text" class="text-lg font-bold text-teal-700">0 / 100</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div id="progress-bar" class="bg-teal-600 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
                <div id="food-grid-container"></div>
                <div id="filter-empty-state" class="hidden text-center py-10 px-4">
                    <i data-lucide="search-x" class="w-12 h-12 text-gray-400 mx-auto"></i>
                    <h3 class="mt-2 text-lg font-medium text-gray-900">No Foods Found</h3>
                    <p class="mt-1 text-sm text-gray-500">No foods match your current filter.</p>
                </div>
            </div>

            <!-- Page 2: Ideas (Recommendations) -->
            <div id="page-ideas" class="page-content py-6 px-4 sm:px-6 lg:px-8 hidden">
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-2xl font-semibold text-gray-800">My Baby's Profile</h2>
                        <span id="profile-display" class="text-lg font-semibold text-teal-600 hidden"></span>
                    </div>
                    <p class="text-sm text-gray-600 mt-1 mb-4">Personalize the app with your baby's name and birth date for age-specific recommendations.</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="baby-name-input" class="block text-sm font-medium text-gray-700">Baby's Name:</label>
                            <input type="text" id="baby-name-input" placeholder="e.g., Alex" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="birth-date-input" class="block text-sm font-medium text-gray-700">Baby's Birth Date:</label>
                            <input type="date" id="birth-date-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm">
                        </div>
                    </div>
                    <button id="save-profile-btn" class="mt-4 w-full inline-flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-teal-600 hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500">
                        Save Profile
                    </button>
                    <button id="log-out-btn" class="mt-4 w-full inline-flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500">
                        Log Out / Change Family ID
                    </button>
                    <hr class="my-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Food Recommendations</h3>
                    <div id="age-display-container" class="mt-6 p-4 bg-teal-50 rounded-md hidden">
                        <p id="age-display" class="text-lg font-medium text-teal-800">Baby's Age: <span class="font-bold"></span></p>
                    </div>
                    <div id="recommendations-container" class="mt-6 space-y-3"></div>
                </div>
            </div>
            
            <!-- *** UPDATED RECIPE PAGE WITH PLANNER *** -->
            <div id="page-recipes" class="page-content py-6 px-4 sm:px-6 lg:px-8 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800">Recipes & Planner</h2>
                    <button id="show-add-recipe-modal-btn" class="inline-flex items-center gap-2 px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-teal-600 hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500">
                        <i data-lucide="plus"></i> Add Recipe
                    </button>
                </div>
                
                <!-- Sub-navigation -->
                <div class="border-b border-gray-200 mb-4">
                    <nav class="flex -mb-px" id="recipe-sub-nav">
                        <button data-subpage="my-recipes" class="recipe-sub-nav-btn active">
                            <i data-lucide="notebook-pen" class="w-4 h-4 inline-block -mt-1 mr-1"></i> My Recipes
                        </button>
                        <button data-subpage="meal-planner" class="recipe-sub-nav-btn">
                            <i data-lucide="calendar-days" class="w-4 h-4 inline-block -mt-1 mr-1"></i> Meal Planner
                        </button>
                    </nav>
                </div>

                <!-- Sub-page: My Recipes -->
                <div id="subpage-my-recipes" class="recipe-sub-page">
                    <p class="text-sm text-gray-600 mb-6">Drag a recipe from this list onto the Meal Planner.</p>
                    <div id="recipe-list-container" class="space-y-4">
                        <!-- Recipe cards will be injected here -->
                    </div>
                </div>

                <!-- Sub-page: Meal Planner -->
                <div id="subpage-meal-planner" class="recipe-sub-page hidden">
                    <div class="bg-white p-4 rounded-lg shadow mb-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold text-gray-800">Weekly Plan</h3>
                            <button id="generate-shopping-list-btn" class="inline-flex items-center gap-2 px-3 py-1.5 border border-transparent text-xs font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700">
                                <i data-lucide="shopping-cart" class="w-4 h-4"></i> Shopping List
                            </button>
                        </div>
                        <!-- Week Navigation -->
                        <div class="flex items-center justify-between">
                            <button id="prev-week-btn" class="p-2 rounded-md hover:bg-gray-100"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                            <div class="flex-1 text-center">
                                <button id="today-btn" class="text-sm font-medium text-teal-600 hover:underline">Today</button>
                                <p id="week-nav-display" class="text-sm font-medium text-gray-700"></p>
                            </div>
                            <button id="next-week-btn" class="p-2 rounded-md hover:bg-gray-100"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                        </div>
                    </div>
                    <!-- Calendar Grid -->
                    <div id="calendar-grid" class="space-y-4">
                        <!-- Calendar days will be injected here -->
                    </div>
                </div>
            </div>

            <!-- Page 3: Log (Summary) -->
            <div id="page-log" class="page-content py-6 px-4 sm:px-6 lg:px-8 hidden">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
                    <h2 class="text-2xl font-semibold text-gray-800">Summary of Tried Foods</h2>
                    <div class="flex-shrink-0 flex gap-2">
                        <button id="export-csv-btn" class="inline-flex items-center gap-2 px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                            <i data-lucide="sheet"></i> CSV
                        </button>
                        <button id="export-pdf-btn" class="inline-flex items-center gap-2 px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                            <i data-lucide="file-text"></i> PDF
                        </button>
                    </div>
                </div>
                <div id="summary-list-container" class="space-y-4"></div>
            </div>

            <!-- Page 4: Learn (Research) -->
            <div id="page-learn" class="page-content py-6 px-4 sm:px-6 lg:px-8 hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Essential BLW Guidelines</h2>
                <p class="text-sm text-gray-600 mb-6">This information is for educational purposes only. Always consult with your pediatrician for personalized medical advice.</p>
                <div id="research-accordion-container" class="space-y-3"></div>
            </div>
        </main>
    </div>

    <!-- Bottom Navigation Bar (5 TABS) -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-20">
        <div class="max-w-7xl mx-auto flex justify-around px-2 sm:px-6 lg:px-8">
            <button data-page="tracker" class="nav-btn flex flex-col items-center justify-center p-3 text-teal-600 w-full"><i data-lucide="grid-3x3"></i><span class="text-xs font-medium">Tracker</span></button>
            <button data-page="ideas" class="nav-btn flex flex-col items-center justify-center p-3 text-gray-500 hover:text-gray-700 w-full"><i data-lucide="lightbulb"></i><span class="text-xs font-medium">Ideas</span></button>
            <button data-page="recipes" class="nav-btn flex flex-col items-center justify-center p-3 text-gray-500 hover:text-gray-700 w-full"><i data-lucide="notebook-pen"></i><span class="text-xs font-medium">Recipes</span></button>
            <button data-page="log" class="nav-btn flex flex-col items-center justify-center p-3 text-gray-500 hover:text-gray-700 w-full"><i data-lucide="clipboard-list"></i><span class="text-xs font-medium">Log</span></button>
            <button data-page="learn" class="nav-btn flex flex-col items-center justify-center p-3 text-gray-500 hover:text-gray-700 w-full"><i data-lucide="book-open"></i><span class="text-xs font-medium">Learn</span></button>
        </div>
    </nav>

    <!-- Food Log Modal -->
    <div id="food-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-auto">
            <div class="flex justify-between items-center border-b p-4">
                <h2 class="text-xl font-semibold">Log Food: <span id="modal-food-name" class="text-teal-600"></span></h2>
                <div>
                    <button id="show-guide-btn" type="button" class="text-sm text-teal-600 font-medium inline-flex items-center gap-1 hover:text-teal-700">
                        <i data-lucide="help-circle" class="w-4 h-4"></i> How to Serve
                    </button>
                    <button id="modal-close-btn" class="text-gray-400 hover:text-gray-600 ml-3"><i data-lucide="x"></i></button>
                </div>
            </div>
            <form id="modal-form" class="p-6 space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">1. How did baby react?</label>
                    <!-- *** EMOJIS RE-ADDED HERE *** -->
                    <div id="reaction-btn-group" class="grid grid-cols-4 gap-2">
                        <button type="button" data-value="1" class="reaction-btn text-lg p-2 border border-gray-300 rounded-lg flex flex-col items-center text-gray-600 hover:border-gray-400"><span>ü§¢</span><span class="text-xs mt-1">Hated it</span></button>
                        <button type="button" data-value="3" class="reaction-btn text-lg p-2 border border-gray-300 rounded-lg flex flex-col items-center text-gray-600 hover:border-gray-400"><span>ü§î</span><span class="text-xs mt-1">Meh</span></button>
                        <button type="button" data-value="5" class="reaction-btn text-lg p-2 border border-gray-300 rounded-lg flex flex-col items-center text-gray-600 hover:border-gray-400"><span>üôÇ</span><span class="text-xs mt-1">Liked it</span></button>
                        <button type="button" data-value="7" class="reaction-btn text-lg p-2 border border-gray-300 rounded-lg flex flex-col items-center text-gray-600 hover:border-gray-400"><span>üòç</span><span class="text-xs mt-1">Loved it!</span></button>
                    </div>
                </div>
                <div>
                    <label for="feeding-date" class="block text-sm font-medium text-gray-700">2. Date of feeding:</label>
                    <input type="date" id="feeding-date" name="feeding-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm" required>
                </div>
                <fieldset id="bite-btn-group">
                    <legend class="text-sm font-medium text-gray-700">3. How much did baby eat?</legend>
                    <div class="mt-2 grid grid-cols-2 gap-3">
                        <button type="button" data-value="no" class="bite-btn p-3 border border-gray-300 rounded-lg flex items-center justify-center gap-2 text-gray-600 hover:border-gray-400"><i data-lucide="minus-circle" class="w-5 h-5"></i><span class="text-sm font-medium">Just a taste</span></button>
                        <button type="button" data-value="yes" class="bite-btn p-3 border border-gray-300 rounded-lg flex items-center justify-center gap-2 text-gray-600 hover:border-gray-400"><i data-lucide="plus-circle" class="w-5 h-5"></i><span class="text-sm font-medium">More than 1 bite</span></button>
                    </div>
                </fieldset>
                <input type="hidden" id="reaction-hidden" name="reaction">
                <input type="hidden" id="bite-hidden" name="bite">
                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button type="button" id="modal-cancel-btn" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500">
                        Cancel
                    </button>
                    <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-teal-600 hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500">
                        Save
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- "How to Serve" Modal -->
    <div id="how-to-serve-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-[500] hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-auto">
            <div class="flex justify-between items-center border-b p-4">
                <h2 class="text-xl font-semibold">How to Serve: <span id="serve-guide-food-name" class="text-teal-600"></span></h2>
                <button id="serve-guide-close-btn" class="text-gray-400 hover:text-gray-600"><i data-lucide="x"></i></button>
            </div>
            <div class="p-6 modal-scroll-content prose-static">
                <div id="serve-guide-content">
                    <!-- Content will be injected by JS -->
                </div>
                <p class="mt-6 text-xs text-gray-500 border-t pt-4">
                    <strong>Disclaimer:</strong> This is for informational purposes only. Consult with a pediatrician or feeding specialist for personalized advice. Always ensure food is soft-cooked and served in a safe, age-appropriate manner.
                </p>
            </div>
        </div>
    </div>
    
    <!-- "Add Recipe" Modal -->
    <div id="add-recipe-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-[500] hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-auto">
            <form id="add-recipe-form">
                <div class="flex justify-between items-center border-b p-4">
                    <h2 class="text-xl font-semibold">Add New Recipe</h2>
                    <button id="add-recipe-close-btn" type="button" class="text-gray-400 hover:text-gray-600"><i data-lucide="x"></i></button>
                </div>
                <div class="p-6 modal-scroll-content space-y-4">
                    <div>
                        <label for="recipe-title" class="block text-sm font-medium text-gray-700">Recipe Title</label>
                        <input type="text" id="recipe-title" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm" required>
                    </div>
                    <div>
                        <label for="recipe-ingredients" class="block text-sm font-medium text-gray-700">Ingredients</label>
                        <textarea id="recipe-ingredients" rows="5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm" placeholder="e.g.,&#10;- 1 cup oats&#10;- 1/2 banana, mashed"></textarea>
                    </div>
                    <div>
                        <label for="recipe-instructions" class="block text-sm font-medium text-gray-700">Instructions</label>
                        <textarea id="recipe-instructions" rows="7" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm" placeholder="e.g.,&#10;1. Mix all ingredients.&#10;2. Form into patties.&#10;3. Bake at 350¬∞F for 15 minutes."></textarea>
                    </div>
                    <div>
                        <label for="recipe-tags" class="block text-sm font-medium text-gray-700">Tags (comma separated)</label>
                        <input type="text" id="recipe-tags" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm" placeholder="e.g., muffin, 6m+, egg-free">
                    </div>
                </div>
                <div class="flex justify-end space-x-3 p-4 border-t bg-gray-50 rounded-b-lg">
                    <button type="button" id="add-recipe-cancel-btn" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-teal-600 hover:bg-teal-700">Save Recipe</button>

                </div>
            </form>
        </div>
    </div>
    
    <!-- "View Recipe" Modal -->
    <div id="view-recipe-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-[500] hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-auto">
            <div class="flex justify-between items-center border-b p-4">
                <h2 id="view-recipe-title" class="text-xl font-semibold text-teal-600"></h2>
                <button id="view-recipe-close-btn" type="button" class="text-gray-400 hover:text-gray-600"><i data-lucide="x"></i></button>
            </div>
            <div class="p-6 modal-scroll-content prose-static">
                <div id="view-recipe-tags" class="mb-4"></div>
                <h3 class="text-lg font-medium text-gray-800">Ingredients</h3>
                <div id="view-recipe-ingredients" class="mb-4"></div>
                <h3 class="text-lg font-medium text-gray-800">Instructions</h3>
                <div id="view-recipe-instructions"></div>
            </div>
        </div>
    </div>
    
    <!-- *** NEW SHOPPING LIST MODAL *** -->
    <div id="shopping-list-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-[500] hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-auto">
            <div class="flex justify-between items-center border-b p-4">
                <h2 class="text-xl font-semibold text-gray-800">Weekly Shopping List</h2>
                <button id="shopping-list-close-btn" type="button" class="text-gray-400 hover:text-gray-600"><i data-lucide="x"></i></button>
            </div>
            <div class="p-6 modal-scroll-content prose-static">
                <p class="text-sm text-gray-600 mb-4">This is a combined list of all ingredients from your planned meals for the week.</p>
                <div id="shopping-list-content">
                    <!-- Shopping list will be injected here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- *** NEW VIEW PLANNED MEAL MODAL *** -->
    <div id="view-planned-meal-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-[500] hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-xs mx-auto">
            <div class="flex justify-between items-center border-b p-4">
                <h2 id="view-planned-meal-title" class="text-lg font-semibold text-teal-600"></h2>
                <button id="view-planned-meal-close-btn" type="button" class="text-gray-400 hover:text-gray-600"><i data-lucide="x"></i></button>
            </div>
            <div class="p-4 space-y-3">
                <button id="view-recipe-details-btn" class="w-full inline-flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-teal-600 hover:bg-teal-700">View Recipe</button>
                <button id="remove-planned-meal-btn" class="w-full inline-flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-red-600 bg-white hover:bg-gray-50">Remove from Plan</button>
            </div>
        </div>
    </div>

    <!-- Family ID Login Modal -->
    <div id="family-id-modal" class="fixed inset-0 bg-gray-600 bg-opacity-90 flex items-center justify-center p-4 z-[999] hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-auto p-6">
            <h2 class="text-2xl font-bold text-gray-800 text-center">Welcome!</h2>
            <p class="text-center text-gray-600 mt-2 mb-6">Create a shared Family ID to track progress across devices.</p>
            
            <div class="space-y-4">
                <div>
                    <label for="family-id-input" class="block text-sm font-medium text-gray-700">Create or Join a Family ID</label>
                    <input type="text" id="family-id-input" placeholder="e.g., smith-baby-2025" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm">
                    <p class="mt-2 text-xs text-gray-500">This is case-sensitive. Share it exactly with your family members.</p>
                </div>
                <button id="join-family-btn" class="w-full inline-flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-teal-600 hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500">
                    Join / Create Tracker
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc,
            collection,
            onSnapshot,
            addDoc,
            Timestamp,
            deleteDoc, // NEW: for removing meals
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- App Constants ---
        
        // =======================================================================
        // === 1. PASTE YOUR FIREBASE CONFIG OBJECT HERE ===
        // =======================================================================
        // Go to your Firebase project, add a Web App (</>), and copy the config.
        const firebaseConfig = {apiKey: "AIzaSyA3Qw1oZInrhteTAd7iOK1D2bMHMVCG4EE",
  authDomain: "tiny-tastes-tracker.firebaseapp.com",
  projectId: "tiny-tastes-tracker",
  storageBucket: "tiny-tastes-tracker.firebasestorage.app",
  messagingSenderId: "87950543929",
  appId: "1:87950543929:web:561607c04f73369f6411e8",
  measurementId: "G-5K38CPMFS8"}; // <-- PASTE YOUR CONFIG OBJECT HERE

        // =======================================================================
        // === 2. PASTE YOUR PROJECT ID HERE ===
        // =======================================================================
        // Copy the 'projectId' value from the firebaseConfig object above.
        const appId = "tiny-tastes-tracker"; // <-- e.g., "tiny-tastes-tracker-123"
        
        // =======================================================================

        const placeholderImgBase = "https-placehold-co-";
        
        // *** EMOJIS RE-ADDED HERE ***
        const allFoods = [
            {
                category: "Vegetables",
                color: "bg-green-100", textColor: "text-green-800", borderColor: "border-green-300",
                items: [
                    { name: "ASPARAGUS", emoji: " " }, { name: "BUTTERNUT SQUASH", emoji: "üéÉ" }, { name: "CAULIFLOWER", emoji: "ü•¶" },
                    { name: "SWEET POTATO", emoji: "üç†" }, { name: "POTATOES", emoji: "ü•î" }, { name: "PARSNIPS", emoji: "ü•ï" },
                    { name: "BELL PEPPERS", emoji: "ü´ë" }, { name: "BEETS", emoji: "üíú" }, { name: "CHAYOTE SQUASH", emoji: "üçê" },
                    { name: "PUMPKIN", emoji: "üéÉ" }, { name: "CARROTS", emoji: "ü•ï" }, { name: "ZUCCHINI", emoji: "ü•í" },
                    { name: "MUSHROOMS", emoji: "üçÑ" }, { name: "ONION", emoji: "üßÖ" }, { name: "BRUSSELS SPROUTS", emoji: "ü•¨" },
                    { name: "CORN", emoji: "üåΩ" }, { name: "CUCUMBER", emoji: "ü•í" }, { name: "CELERY", emoji: "ü•¨" },
                    { name: "PEAS", emoji: "ü´õ" }, { name: "SNAP PEAS", emoji: "ü´õ" }, { name: "CILANTRO", emoji: "üåø" },
                    { name: "EGGPLANT", emoji: "üçÜ" }, { name: "GARLIC", emoji: "üßÑ" }, { name: "PARSLEY", emoji: "üåø" },
                    { name: "KALE", emoji: "ü•¨" }, { name: "ARTICHOKE", emoji: "üíö" }, { name: "BROCCOLI", emoji: "ü•¶" }
                ]
            },
            {
                category: "Grains",
                color: "bg-yellow-100", textColor: "text-yellow-800", borderColor: "border-yellow-300",
                items: [
                    { name: "KAMUT", emoji: "üåæ" }, { name: "CEREALS", emoji: "ü•£" }, { name: "MILLET", emoji: "üåæ" },
                    { name: "OATMEAL", emoji: "ü•£" }, { name: "BUCKWHEAT", emoji: "üåæ" }, { name: "WAFFLES", emoji: "üßá" },
                    { name: "HEALTHY MUFFINS", emoji: "üßÅ" }, { name: "PASTA", emoji: "üçù" }, { name: "COUSCOUS", emoji: "üçõ" },
                    { name: "POLENTA", emoji: "üåΩ" }, { name: "CORNMEAL", emoji: "üåΩ" }, { name: "BREAD", emoji: "üçû" },
                    { name: "GNOCCHI", emoji: "ü•î" }, { name: "TORTILLA", emoji: "üåÆ" }, { name: "FARRO", emoji: "üåæ" },
                    { name: "BARLEY", emoji: "üåæ" }, { name: "BULGUR", emoji: "üåæ" }, { name: "BROWN RICE", emoji: "üçö" },
                    { name: "QUINOA", emoji: "üçö" }, { name: "FREEKEH", emoji: "üåæ" }
                ]
            },
            {
                category: "Fruits",
                color: "bg-pink-100", textColor: "text-pink-800", borderColor: "border-pink-300",
                items: [
                    { name: "AVOCADO", emoji: "ü•ë" }, { name: "TOMATOES", emoji: "üçÖ" }, { name: "ORANGE", emoji: "üçä" },
                    { name: "LEMON & LIME", emoji: "üçã" }, { name: "PAPAYA", emoji: "ü•≠" }, { name: "PINEAPPLE", emoji: "üçç" },
                    { name: "KIWIFRUIT", emoji: "ü•ù" }, { name: "MANGO", emoji: "ü•≠" }, { name: "STARFRUIT", emoji: "‚≠ê" },
                    { name: "FIGS", emoji: "üíú" }, { name: "BANANA", emoji: "üçå" }, { name: "COCONUT", emoji: "ü••" },
                    { name: "WATERMELON", emoji: "üçâ" }, { name: "HONEYDEW", emoji: "üçà" }, { name: "CANTALOUPE", emoji: "üçà" },
                    { name: "APPLESAUCE", emoji: "üçé" }, { name: "RASPBERRIES", emoji: "üçì" }, { name: "BLUEBERRIES", emoji: "ü´ê" },
                    { name: "STRAWBERRIES", emoji: "üçì" }, { name: "GRAPES", emoji: "üçá" }, { name: "PEACHES", emoji: "üçë" },
                    { name: "PEARS", emoji: "üçê" }, { name: "APPLES", emoji: "üçé" }
                ]
            },
            {
                category: "Plant Protein",
                color: "bg-blue-100", textColor: "text-blue-800", borderColor: "border-blue-300",
                items: [
                    { name: "TOFU", emoji: "ü§ç" }, { name: "EDAMAME", emoji: "ü´õ" }, { name: "PEANUTS", emoji: "ü•ú" },
                    { name: "ALMONDS", emoji: "üå∞" }, { name: "WHITE BEANS", emoji: "ü´ò" }, { name: "CHICKPEAS", emoji: "ü´ò" },
                    { name: "BLACK BEANS", emoji: "ü´ò" }, { name: "KIDNEY BEANS", emoji: "ü´ò" },
                    { name: "LENTILS", emoji: "üçõ" }, { name: "ALMOND BUTTER", emoji: "üå∞" }, { name: "PEANUT BUTTER", emoji: "ü•ú" }, { name: "SEEDS", emoji: "üå±" }
                ]
            },
            {
                category: "Meat",
                color: "bg-red-100", textColor: "text-red-800", borderColor: "border-red-300",
                items: [
                    { name: "FISH", emoji: "üêü" }, { name: "TUNA", emoji: "üêü" }, { name: "SARDINES", emoji: "üêü" },
                    { name: "SALMON", emoji: "üêü" }, { name: "SHRIMP", emoji: "ü¶ê" }, { name: "BEEF, SLICED", emoji: "ü•©" },
                    { name: "BEEF, GROUND", emoji: "üçî" }, { name: "CHICKEN", emoji: "üçó" }, { name: "LAMB", emoji: "üêë" },
                    { name: "TURKEY", emoji: "ü¶É" }, { name: "PORK", emoji: "üêñ" }
                ]
            },
            {
                category: "Dairy & Eggs",
                color: "bg-purple-100", textColor: "text-purple-800", borderColor: "border-purple-300",
                items: [
                    { name: "YOGURT", emoji: "ü•£" }, { name: "EGGS", emoji: "ü•ö" }, { name: "MOZZARELLA", emoji: "üßÄ" },
                    { name: "RICOTTA CHEESE", emoji: "üßÄ" }, { name: "COTTAGE CHEESE", emoji: "üßÄ" }
                ]
            },
            {
                category: "Other",
                color: "bg-gray-100", textColor: "text-gray-800", borderColor: "border-gray-300",
                items: [
                    { name: "WATER", emoji: "üíß" },
                    { name: "SPICES & HERBS", emoji: "üåø" }
                ]
            }
        ];
        
        const flatFoodList = allFoods.flatMap(cat => cat.items.map(item => item.name));
        const totalFoodCount = flatFoodList.length; 

        const foodGuideData = {
            "AVOCADO": {
                allergyRisk: "Low",
                chokingRisk: "Low",
                serve6to8: "<h4 class='font-semibold'>6-8 Months:</h4><p>Serve ripe avocado in long, thick spears (about the width of two adult fingers). You can roll the spears in a 'duster' like crushed cereal, hemp seeds, or nutritional yeast to make it less slippery and easier to grip.</p>",
                serve9to12: "<h4 class='font-semibold mt-4'>9-12 Months:</h4><p>As baby develops a pincer grasp, you can offer ripe avocado in small, pincer-sized cubes. You can also continue to serve spears or mashed on a pre-loaded spoon.</p>"
            },
            "EGGS": {
                allergyRisk: "High (Top 9 Allergen)",
                chokingRisk: "Low",
                serve6to8: "<h4 class='font-semibold'>6-8 Months:</h4><p>Offer fully-cooked egg only. A great way is to make a simple 'omelet strip' by whisking one egg and cooking it flat in a pan. Cut it into long, 1-inch wide strips for baby to hold.</p><p class='mt-2'><strong>Allergy Info:</strong> Egg is a top allergen. Introduce it on its own and wait 3-5 days before introducing other new allergens. Start with a small amount.</p>",
                serve9to12: "<h4 class='font-semibold mt-4'>9-12 Months:</h4><p>You can serve scrambled eggs (cooked through) or chopped hard-boiled eggs for pincer grasp practice. Continue offering omelet strips as well.</p>"
            },
            "PEANUTS": {
                allergyRisk: "High (Top 9 Allergen)",
                chokingRisk: "High (When whole or in gobs)",
                serve6to8: "<h4 class='font-semibold'>6-8 Months:</h4><p><strong>NEVER</strong> serve whole peanuts, peanut pieces, or thick, sticky gobs of peanut butter, as these are severe choking hazards.</p><p class='mt-2'><strong>To serve safely:</strong><br>1. Thin a small amount (1-2 teaspoons) of smooth peanut butter with water, breastmilk, or formula to a thin, 'sauce-like' consistency and offer on a spoon.<br>2. Or, stir a small amount of smooth peanut butter into yogurt or oatmeal.<br>3. Or, spread a *very* thin layer (almost see-through) on a piece of toast, cut into strips.</p><p class='mt-2'><strong>Allergy Info:</strong> Peanuts are a top allergen. Introduce it early and often (after 6 months) to help prevent allergy. Start with a tiny amount.</p>",
                serve9to12: "<h4 class='font-semibold mt-4'>9-12 Months:</h4><p>Continue serving as above. You can still spread a thin layer on toast or mix into other foods. Avoid whole peanuts until at least age 4-5.</p>"
            },
            "CARROTS": {
                allergyRisk: "Low",
                chokingRisk: "High (When raw or undercooked)",
                serve6to8: "<h4 class='font-semibold'>6-8 Months:</h4><p><strong>NEVER</strong> serve raw baby carrots or raw carrot sticks. They are a major choking hazard.</p><p class='mt-2'>Carrots must be cooked until <strong>very soft</strong> (you can easily smash it between your thumb and forefinger). Serve in long, 1-inch thick spears (about the size of an adult finger) that have been roasted or steamed until tender.</p>",
                serve9to12: "<h4 class='font-semibold mt-4'>9-12 Months:</h4><p>Continue serving soft-cooked spears, or offer in small, soft-cooked, pincer-sized pieces. You can also offer shredded raw carrot, as this is much safer than a raw stick, but supervision is key.</p>"
            },
            "APPLES": {
                allergyRisk: "Low",
                chokingRisk: "High (When raw)",
                serve6to8: "<h4 class='font-semibold'>6-8 Months:</h4><p><strong>NEVER</strong> serve raw, hard apple pieces or whole apples. They are a major choking hazard.</p><p class='mt-2'>Serve in one of two ways:<br>1. Offer unsweetened applesauce on a pre-loaded spoon.<br>2. Cook apple spears (with skin removed) by steaming or roasting them until they are very soft all the way through. They should be easily smushed between your fingers.</p>",
                serve9to12: "<h4 class='font-semibold mt-4'>9-12 Months:</h4><p>Continue serving soft-cooked apples or applesauce. As baby develops, you can offer shredded raw apple, which is safer than chunks. Do not serve hard, raw apple chunks.</p>"
            },
            "BANANA": {
                allergyRisk: "Low",
                chokingRisk: "Low (when ripe)",
                serve6to8: "<h4 class='font-semibold'>6-8 Months:</h4><p>Serve a whole, ripe banana, but leave the bottom third of the peel on as a 'handle' for baby to grip. You can also serve it in long spears, rolled in a 'duster' (like crushed cereal or hemp seeds) to make it less slippery.</p>",
                serve9to12: "<h4 class='font-semibold mt-4'>9-12 Months:</h4><p>As baby develops a pincer grasp, you can offer small, bite-sized pieces of ripe banana. You can also continue to serve it in spears or mashed.</p>"
            },
            "OATMEAL": {
                allergyRisk: "Low (Oats are not a top 9 allergen, but check for cross-contamination if Celiac disease is a concern)",
                chokingRisk: "Low",
                serve6to8: "<h4 class='font-semibold'>6-8 Months:</h4><p>Make oatmeal thick so it's not runny. Offer it on a pre-loaded spoon (like a Go-O utensil) that you hand to your baby. You can also let them scoop it with their hands. Mix in allergens like thinned peanut butter or yogurt.</p>",
                serve9to12: "<h4 class='font-semibold mt-4'>9-12 Months:</h4><p>Continue serving as above. You can also bake oatmeal into 'oatmeal fingers' or muffins for an easy-to-hold, portable option.</p>"
            },
            "CHICKEN": {
                allergyRisk: "Low",
                chokingRisk: "Medium (When dry, tough, or in cubes)",
                serve6to8: "<h4 class='font-semibold'>6-8 Months:</h4><p><strong>NEVER</strong> serve in cubes or chunks. Chicken must be very soft and moist. The safest way is to offer a large, long strip (about the size of two adult fingers) of *dark meat* (like thigh or drumstick), which is more tender and iron-rich. Ensure it's cooked through and any gristle/bone is removed. You can also serve ground chicken in a soft-cooked meatball or patty.</p>",
                serve9to12: "<h4 class='font-semibold mt-4'>9-12 Months:</h4><p>As baby's grasp improves, you can offer smaller, shredded pieces of moist chicken. Continue to avoid hard, dry cubes. Ground chicken patties or meatballs are still an excellent choice.</p>"
            },
            "SWEET POTATO": {
                allergyRisk: "Low",
                chokingRisk: "Low (when soft-cooked)",
                serve6to8: "<h4 class='font-semibold'>6-8 Months:</h4><p>Sweet potato must be cooked until very soft (easily smushed between your fingers). Serve as a large, soft-cooked spear (width of 2 fingers) or mashed on a pre-loaded spoon.</p>",
                serve9to12: "<h4 class='font-semibold mt-4'>9-12 Months:</h4><p>Continue serving as soft spears or mashed. As pincer grasp develops, you can offer small, soft-cooked cubes for baby to practice picking up.</p>"
            },
            "EGGPLANT": {
                allergyRisk: "Low (though a rare allergen)",
                chokingRisk: "Low (when soft-cooked)",
                serve6to8: "<h4 class='font-semibold'>6-8 Months:</h4><p>Serve eggplant cooked until completely soft and tender. Large, long spears (with skin removed) that are roasted or steamed are perfect. You can also serve it mashed or as part of a dip like baba ganoush (watch the salt!).</p>",
                serve9to12: "<h4 class='font-semibold mt-4'>9-12 Months:</h4><p>Continue serving soft-cooked spears or offer soft-cooked, pincer-sized cubes. Eggplant is great at soaking up flavors in stews or pasta sauces.</p>"
            },
            "ZUCCHINI": {
                allergyRisk: "Low",
                chokingRisk: "Low (when soft-cooked)",
                serve6to8: "<h4 class='font-semibold'>6-8 Months:</h4><p>Zucchini must be cooked until very soft. Serve as large, soft-cooked spears (width of 2 fingers) with the skin on (for better grip) or off. Roasting or steaming works well. Avoid raw zucchini.</p>",
                serve9to12: "<h4 class='font-semibold mt-4'>9-12 Months:</h4><p>Continue serving soft-cooked spears. As pincer grasp develops, you can offer small, soft-cooked cubes (skin on or off). Shredded zucchini (raw or cooked) can also be mixed into muffins, pancakes, or fritters.</p>"
            },
            "BROCCOLI": {
                allergyRisk: "Low",
                chokingRisk: "Medium (when raw or hard)",
                serve6to8: "<h4 class='font-semibold'>6-8 Months:</h4><p>Broccoli must be steamed or roasted until the stem is very soft (easily smushed between your fingers). Serve a large floret with a long 'handle' of the stem for baby to hold.</p>",
                serve9to12: "<h4 class='font-semibold mt-4'>9-12 Months:</h4><p>Continue serving soft-cooked florets, or chop the florets into small, pincer-sized pieces (both stem and flower) once soft-cooked.</p>"
            },
            "YOGURT": {
                allergyRisk: "High (Top 9 Allergen - Cow's Milk)",
                chokingRisk: "Low",
                serve6to8: "<h4 class='font-semibold'>6-8 Months:</h4><p>Serve plain, whole-milk (full-fat) yogurt with no added sugars. Offer it on a pre-loaded spoon for baby to grab. You can also mix in thinned peanut butter or fruit pur√©es (once those are introduced).</p><p class='mt-2'><strong>Allergy Info:</strong> This is a top allergen. Introduce it on its own and wait 3-5 days before other new allergens. Start with a small amount.</p>",
                serve9to12: "<h4 class='font-semibold mt-4'>9-12 Months:</h4><p>Continue serving plain, whole-milk yogurt. You can start to mix in soft fruits or berries (smashed or quartered).</p>"
            },
            "WATER": {
                allergyRisk: "Low",
                chokingRisk: "Low",
                serve6to8: "<h4 class='font-semibold'>6-8 Months:</h4><p>Offer a small amount (1-2 oz) of water in an open cup or a straw cup with meals. This is primarily for learning to drink, not for hydration (which still comes from breastmilk/formula).</p>",
                serve9to12: "<h4 class='font-semibold mt-4'>9-12 Months:</h4><p>Continue offering water with all meals in an open cup or straw cup. Baby will gradually get better at sipping and drinking.</p>"
            }
        };

        // *** FIX: REMOVED DUPLICATE recommendationData OBJECTS ***
        const recommendationData = {
            'too_young': { title: "Not Quite 6 Months", foods: [], message: "Most pediatricians recommend starting solids around 6 months, when baby shows all signs of readiness. See the 'Learn' tab for more info!" },
            '6_months': { title: "6 Months: First Tastes", foods: ["AVOCADO", "SWEET POTATO", "BANANA", "OATMEAL", "EGGPLANT", "ZUCCHINI", "BROCCOLI", "CARROTS", "EGGS", "YOGURT", "WATER"], message: "Focus on soft, single-ingredient foods. Offer soft-cooked spears or large pieces. This is a great time to safely introduce top allergens like egg and yogurt (see Learn tab!). Offer sips of water with meals." },
            '7_8_months': { title: "7-8 Months: Exploring Textures", foods: ["CHICKEN", "SALMON", "TOFU", "LENTILS", "BREAD", "PEANUT BUTTER", "ALMOND BUTTER", "APPLES", "PEARS", "PASTA", "SPICES & HERBS"], message: "Baby is likely getting better at mashing and moving food. You can offer softer proteins and continue introducing allergens. Now is a great time to add spices (like cinnamon or garlic powder) to foods!" },
            '9_11_months': { title: "9-11 Months: Pincer Grasp Practice", foods: ["PEAS", "BLUEBERRIES", "RASPBERRIES", "CUCUMBER", "COTTAGE CHEESE", "BEEF, GROUND", "BLACK BEANS", "CORN", "GRAPES", "TOMATOES"], message: "Baby may be starting to use their pincer grasp. Offer smaller, soft-cooked foods (e.g., cut grapes in quarters, smash blueberries/peas) to help them practice." },
            '12_plus': { title: "12+ Months: Try Everything!", foods: flatFoodList, message: "By 12 months, your baby can eat most of what you eat (with appropriate modifications for salt, spice, and choking hazards). Work your way through the rest of the 100 foods list!" }
        };

        const researchData = [
            { 
                title: "Original '100 Foods' Chart", 
                icon: "image",
                content: `<p>Here is the original chart that inspired this tracker. Use it as a quick visual reference!</p><img src="https://storage.googleapis.com/aletheia-us-west1-prod-onboarding/blw-100-foods-chart.jpeg" alt="100 Foods for Baby Chart by The Fortified Family" class="w-full h-auto rounded-md shadow-md mt-4" onerror="this.onerror=null; this.src='https://placehold.co/600x800/eeeeee/999999?text=Could+not+load+image';">`
            },
            { 
                title: "1. Key Signs of Readiness", 
                icon: "clipboard-check",
                content: `<p>Age alone isn't the only factor. Before starting any solids (pur√©es or BLW), your baby should meet <strong>all</strong> of these milestones, which typically happen around 6 months:</p><ul class="list-disc list-outside space-y-2 pl-5"><li><strong>Sits Independently:</strong> Baby can sit in a high chair unassisted or with minimal support and has good head and neck control. This is crucial for safely managing food and swallowing.</li><li><strong>Lost Tongue-Thrust Reflex:</strong> Baby no longer automatically pushes food out of their mouth with their tongue. You can test this by offering a (safe) empty spoon; if they push it out, they're likely not ready.</li><li><strong>Interest in Food:</strong> Baby watches you eat with interest, leans forward, and may try to grab food from your plate.</li><li><strong>Can Grab and Hold:</strong> Baby has developed the motor skills to pick up pieces of food and bring them to their mouth.</li></ul>`
            },
            {
                title: "2. Introducing Top Allergens",
                icon: "peanut",
                content: `<p>Current guidelines have changed: experts now recommend introducing top allergenic foods <strong>early and often</strong> (after 6 months and once a few other foods have been tolerated) to help *prevent* allergies.</p><p>The top 9 allergens account for ~90% of food allergies:</p><ol class="list-decimal list-outside space-y-2 pl-5"><li>Cow's Milk (e.g., in yogurt, cheese)</li><li>Egg (fully cooked, e.g., scrambled or in a muffin)</li><li>Peanuts (NEVER whole. Offer as a thin paste on toast or watered down.)</li><li>Tree Nuts (e.g., almond, walnut. Offer as nut butter, same as peanuts.)</li><li>Fish (e.g., soft, flaky salmon)</li><li>Shellfish (e.g., minced shrimp)</li><li>Soy (e.g., tofu, edamame)</li><li>Wheat (e.g., toast, pasta)</li><li>Sesame (e.g., tahini swirled into yogurt)</li></ol><p><strong>SafetyProtocol:</strong> Introduce one allergen at a time. Wait 3-5 days before introducing another new allergen to watch for any reaction (hives, vomiting, swelling, wheezing). Once an allergen is successfully introduced, keep offering it regularly (e.g., 2-3 times a week) to maintain tolerance.</p>`
            },
            {
                title: "3. The Importance of Iron",
                icon: "beef",
                content: `<p>This is a common concern with BLW. At 6 months, a baby's natural iron stores (which they built up in the womb) begin to deplete. Breast milk is naturally low in iron. While formula and iron-fortified cereals are packed with it, BLW babies may not consume large quantities of cereal.</p><p>It is <strong>essential</strong> to offer iron-rich foods at every meal.</p><ul class="list-disc list-outside space-y-2 pl-5"><li><strong>Heme Iron (Easily Absorbed):</strong> Beef (slow-cooked strips, ground beef), chicken (dark meat), turkey (dark meat), salmon, sardines.</li><li><strong>Non-Heme Iron:</strong> Lentils, tofu, chickpeas, black beans, edamame, eggs, iron-fortified oatmeal/cereal (can be used in muffins or pancakes).</li></ul><p><strong>Pro-Tip:</strong> Pair non-heme iron foods with a food high in Vitamin C to dramatically boost absorption! (e.g., lentils with tomatoes, tofu with bell peppers, oatmeal with strawberries).</p>`
            },
            {
                title: "4. Reputable Sources",
                icon: "book-text",
                content: `<p>For more detailed information, you can look up guidelines from these trusted organizations:</p><ul class="list-disc list-outside space-y-2 pl-5"><li>American Academy of Pediatrics (AAP)</li><li>Centers for Disease C-ntrol and Prevention (CDC)</li><li>World Health Organization (WHO)</li><li>Solid Starts (A popular, comprehensive app and website)</li></ul>`
            }
        ];

        let db;
        let auth;
        let sharedFamilyId; 
        let currentFoodName = null;
        let triedFoodsListener = null;
        let recipesListener = null;
        let mealPlanListener = null; // NEW: For meal plan
        let triedFoodsData = [];
        let recipesData = [];
        let mealPlanData = {}; // NEW: Store as object { 'YYYY-MM-DD': { breakfast: ..., lunch: ... } }
        let currentWeekStartDate = getStartOfWeek(new Date()); // NEW: Date object
        let babyBirthDate = null;
        let babyName = null; 
        let pediatricianApproved = false;
        let currentPage = 'tracker';
        let currentRecipeSubPage = 'my-recipes'; // NEW
        let currentFilter = 'all'; 
        let researchAccordionRendered = false;

        // Modals
        const familyIdModal = document.getElementById('family-id-modal');
        const modal = document.getElementById('food-modal');
        const serveGuideModal = document.getElementById('how-to-serve-modal');
        const addRecipeModal = document.getElementById('add-recipe-modal');
        const viewRecipeModal = document.getElementById('view-recipe-modal');
        const shoppingListModal = document.getElementById('shopping-list-modal'); // NEW
        const viewPlannedMealModal = document.getElementById('view-planned-meal-modal'); // NEW

        // Family ID
        const familyIdInput = document.getElementById('family-id-input');
        const joinFamilyBtn = document.getElementById('join-family-btn');
        const logOutBtn = document.getElementById('log-out-btn');
        
        // Food Log Modal
        const modalForm = document.getElementById('modal-form');
        const modalFoodName = document.getElementById('modal-food-name');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const showGuideBtn = document.getElementById('show-guide-btn');
        const reactionBtnGroup = document.getElementById('reaction-btn-group');
        const reactionHidden = document.getElementById('reaction-hidden');
        const biteBtnGroup = document.getElementById('bite-btn-group');
        const biteHidden = document.getElementById('bite-hidden');
        const feedingDate = document.getElementById('feeding-date');
        
        // Serve Guide Modal
        const serveGuideCloseBtn = document.getElementById('serve-guide-close-btn');
        const serveGuideFoodName = document.getElementById('serve-guide-food-name');
        const serveGuideContent = document.getElementById('serve-guide-content');

        // Recipe Page
        const recipeSubNav = document.getElementById('recipe-sub-nav');
        const recipeSubPages = document.querySelectorAll('.recipe-sub-page');
        const showAddRecipeModalBtn = document.getElementById('show-add-recipe-modal-btn');
        const recipeListContainer = document.getElementById('recipe-list-container');
        
        // Add Recipe Modal
        const addRecipeCloseBtn = document.getElementById('add-recipe-close-btn');
        const addRecipeCancelBtn = document.getElementById('add-recipe-cancel-btn');
        const addRecipeForm = document.getElementById('add-recipe-form');
        
        // View Recipe Modal
        const viewRecipeCloseBtn = document.getElementById('view-recipe-close-btn');
        const viewRecipeTitle = document.getElementById('view-recipe-title');
        const viewRecipeTags = document.getElementById('view-recipe-tags');
        const viewRecipeIngredients = document.getElementById('view-recipe-ingredients');
        const viewRecipeInstructions = document.getElementById('view-recipe-instructions');
        
        // NEW: Meal Planner Elements
        const calendarGrid = document.getElementById('calendar-grid');
        const weekNavDisplay = document.getElementById('week-nav-display');
        const prevWeekBtn = document.getElementById('prev-week-btn');
        const nextWeekBtn = document.getElementById('next-week-btn');
        const todayBtn = document.getElementById('today-btn');
        const generateShoppingListBtn = document.getElementById('generate-shopping-list-btn');
        const shoppingListContent = document.getElementById('shopping-list-content');
        const shoppingListCloseBtn = document.getElementById('shopping-list-close-btn');
        const viewPlannedMealTitle = document.getElementById('view-planned-meal-title');
        const viewRecipeDetailsBtn = document.getElementById('view-recipe-details-btn');
        const removePlannedMealBtn = document.getElementById('remove-planned-meal-btn');
        const viewPlannedMealCloseBtn = document.getElementById('view-planned-meal-close-btn');

        // Page Elements
        const foodGridContainer = document.getElementById('food-grid-container');
        const filterEmptyState = document.getElementById('filter-empty-state');
        const headerSubtitle = document.getElementById('header-subtitle');
        const summaryListContainer = document.getElementById('summary-list-container');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const exportPdfBtn = document.getElementById('export-pdf-btn');
        const babyNameInput = document.getElementById('baby-name-input');
        const birthDateInput = document.getElementById('birth-date-input');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const profileDisplay = document.getElementById('profile-display');
        const ageDisplayContainer = document.getElementById('age-display-container');
        const ageDisplay = document.getElementById('age-display');
        const recommendationsContainer = document.getElementById('recommendations-container');
        const researchAccordionContainer = document.getElementById('research-accordion-container');
        const progressText = document.getElementById('progress-text');
        const progressBar = document.getElementById('progress-bar');
        const navButtons = document.querySelectorAll('.nav-btn');
        const pages = document.querySelectorAll('.page-content');

        // --- Date Helpers ---
        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is sunday
            return new Date(d.setDate(diff));
        }

        function formatDateString(date) {
            return date.toISOString().split('T')[0]; // YYYY-MM-DD
        }
        
        function getWeekDisplay(startDate) {
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            const options = { month: 'short', day: 'numeric' };
            return `${startDate.toLocaleDateString(undefined, options)} - ${endDate.toLocaleDateString(undefined, options)}`;
        }

        // (renderFoodGrid, createFoodCard, renderSummaryList are unchanged)
        function renderFoodGrid() {
            foodGridContainer.innerHTML = '';
            const triedFoodSet = new Set(triedFoodsData.map(doc => doc.id));
            let totalItemsShown = 0;
            allFoods.forEach(category => {
                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3 sm:gap-4';
                let itemsInThisGrid = 0;
                category.items.forEach(food => {
                    const isTried = triedFoodSet.has(food.name);
                    let shouldShow = false;
                    if (currentFilter === 'all') shouldShow = true;
                    else if (currentFilter === 'to_try' && !isTried) shouldShow = true;
                    else if (currentFilter === 'tried' && isTried) shouldShow = true;
                    if (shouldShow) {
                        grid.appendChild(createFoodCard(food, isTried));
                        itemsInThisGrid++;
                    }
                });
                if (itemsInThisGrid > 0) {
                    const categoryHeader = document.createElement('h2');
                    categoryHeader.className = `text-2xl font-semibold ${category.textColor} mt-8 mb-4`;
                    categoryHeader.textContent = category.category;
                    foodGridContainer.appendChild(categoryHeader);
                    foodGridContainer.appendChild(grid);
                    totalItemsShown += itemsInThisGrid;
                }
            });
            filterEmptyState.classList.toggle('hidden', totalItemsShown > 0);
            lucide.createIcons();
        }

        function createFoodCard(food, isTried) {
            const category = allFoods.find(cat => cat.items.some(item => item.name === food.name));
            if (!category) return document.createElement('div');
            const card = document.createElement('button');
            card.className = `food-card relative ${category.color} ${category.textColor} p-3 h-24 rounded-lg shadow-sm font-medium text-sm text-center flex flex-col items-center justify-center cursor-pointer transition-all duration-200 hover:shadow-md hover:scale-105 border ${category.borderColor}`;
            card.dataset.foodName = food.name;
            card.setAttribute('type', 'button');
            if (isTried) card.classList.add('is-tried');
            card.innerHTML = `<span class="text-3xl">${food.emoji}</span><span class="mt-1 text-center leading-tight">${food.name}</span><div class="check-overlay absolute inset-0 bg-white/70 flex items-center justify-center rounded-lg"><i data-lucide="check-circle-2" class="w-12 h-12 text-teal-600"></i></div>`;
            return card;
        }

        function renderSummaryList(docs) {
            if (docs.length === 0) {
                summaryListContainer.innerHTML = `<p class="text-center text-gray-500 py-6">No foods logged yet. Start tracking on the 'Tracker' tab!</p>`;
                return;
            }
            const sortedDocs = [...docs].sort((a, b) => new Date(b.data().date) - new Date(a.data().date));
            summaryListContainer.innerHTML = sortedDocs.map(doc => {
                const data = doc.data();
                const foodName = doc.id;
                const food = allFoods.flatMap(c => c.items).find(f => f.name === foodName);
                let reactionEmoji = 'üôÇ', reactionText = 'Liked it';
                if (data.reaction <= 2) { reactionEmoji = 'ü§¢'; reactionText = 'Hated it'; }
                else if (data.reaction <= 4) { reactionEmoji = 'ü§î'; reactionText = 'Meh'; }
                else if (data.reaction >= 7) { reactionEmoji = 'üòç'; reactionText = 'Loved it!'; }
                return `
                    <div class="bg-white shadow rounded-lg p-4 border-l-4 border-teal-500">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-800">${food ? food.emoji : 'üçΩÔ∏è'} ${foodName}</h3>
                            <span class="text-sm text-gray-500">${data.date}</span>
                        </div>
                        <div class="mt-3 grid grid-cols-2 gap-4 text-sm">
                            <div class="flex flex-col"><span class="text-gray-500">Reaction</span><span class="font-medium text-gray-700">${reactionEmoji} ${reactionText} (${data.reaction}/7)</span></div>
                            <div class="flex flex-col"><span class="text-gray-500">Amount Eaten</span><span class="font-medium text-gray-700">${data.moreThanOneBite ? 'More than 1 bite' : 'Just a taste'}</span></div>
                        </div>
                    </div>`;
            }).join('');
        }
        
        // --- RECIPE FUNCTIONS ---
        
        function formatRecipeText(text) {
            if (!text) return '';
            const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            let html = '';
            let inList = false;
            for (const line of lines) {
                if (line.startsWith('-') || line.startsWith('*') || /^\d+\./.test(line)) {
                    if (!inList) {
                        html += '<ul>';
                        inList = true;
                    }
                    html += `<li>${line.replace(/^[\*-\s]|^(\d+\.\s)/, '')}</li>`;
                } else {
                    if (inList) {
                        html += '</ul>';
                        inList = false;
                    }
                    html += `<p>${line}</p>`;
                }
            }
            if (inList) html += '</ul>';
            return html;
        }

        // --- NEW/MODIFIED RECIPE FUNCTIONS ---
        
        function renderRecipeList() {
            if (recipesData.length === 0) {
                recipeListContainer.innerHTML = `<p class="text-center text-gray-500 py-10">Your recipe box is empty. Click "Add Recipe" to save your first one!</p>`;
                return;
            }
            
            const sortedRecipes = [...recipesData].sort((a, b) => b.data().createdAt.toMillis() - a.data().createdAt.toMillis());
            
            recipeListContainer.innerHTML = sortedRecipes.map(doc => {
                const recipe = doc.data();
                const recipeId = doc.id;
                const tagsHtml = recipe.tags && recipe.tags.length > 0
                    ? recipe.tags.map(tag => `<span class="text-xs bg-teal-100 text-teal-700 px-2 py-0.5 rounded-full">${tag}</span>`).join(' ')
                    : '';
                
                return `
                <div data-recipe-id="${recipeId}" data-recipe-title="${recipe.title}" draggable="true" class="recipe-card-draggable w-full text-left bg-white shadow rounded-lg p-4 transition-all hover:shadow-md">
                    <h3 class="text-lg font-semibold text-teal-700 pointer-events-none">${recipe.title}</h3>
                    <div class="mt-2 flex flex-wrap gap-2 pointer-events-none">${tagsHtml}</div>
                    <p class="text-sm text-gray-600 mt-3 line-clamp-2 pointer-events-none">${recipe.ingredients.replace(/\n/g, ', ')}</p>
                </div>
                `;
            }).join('');
        }

        function listenToRecipes() {
            if (!db || !sharedFamilyId) return;
            if (recipesListener) recipesListener(); 
            
            const collectionPath = `/artifacts/${appId}/users/${sharedFamilyId}/recipes`;
            const recipesRef = collection(db, collectionPath);
            recipesListener = onSnapshot(recipesRef, (snapshot) => {
                console.log(`Received recipe snapshot with ${snapshot.docs.length} docs.`);
                recipesData = snapshot.docs;
                // Only render if the page is active
                if (currentPage === 'recipes' && currentRecipeSubPage === 'my-recipes') {
                    renderRecipeList();
                }
            }, (error) => console.error("Error listening to recipes: ", error));
        }
        
        async function handleAddRecipe(e) {
            e.preventDefault();
            if (!db || !sharedFamilyId) return;
            
            const title = document.getElementById('recipe-title').value;
            const ingredients = document.getElementById('recipe-ingredients').value;
            const instructions = document.getElementById('recipe-instructions').value;
            const tags = document.getElementById('recipe-tags').value.split(',').map(tag => tag.trim()).filter(Boolean);
            
            if (!title) return;
            
            const collectionPath = `/artifacts/${appId}/users/${sharedFamilyId}/recipes`;
            try {
                await addDoc(collection(db, collectionPath), {
                    title,
                    ingredients,
                    instructions,
                    tags,
                    createdAt: Timestamp.now()
                });
                addRecipeModal.classList.add('hidden');
                addRecipeForm.reset();
            } catch (error) {
                console.error("Error adding recipe: ", error);
            }
        }
        
        function openViewRecipeModal(recipeId) {
            const recipeDoc = recipesData.find(doc => doc.id === recipeId);
            if (!recipeDoc) return;
            const recipe = recipeDoc.data();
            
            viewRecipeTitle.textContent = recipe.title;
            viewRecipeTags.innerHTML = recipe.tags && recipe.tags.length > 0
                ? recipe.tags.map(tag => `<span class="text-xs bg-teal-100 text-teal-700 px-2 py-0.5 rounded-full">${tag}</span>`).join(' ')
                : '<span class="text-xs text-gray-500">No tags</span>';
            
            viewRecipeIngredients.innerHTML = formatRecipeText(recipe.ingredients);
            viewRecipeInstructions.innerHTML = formatRecipeText(recipe.instructions);
            
            viewRecipeModal.classList.remove('hidden');
        }
        
        // --- NEW MEAL PLANNER FUNCTIONS ---

        function initializeRecipePageTabs() {
            recipeSubNav.addEventListener('click', (e) => {
                const btn = e.target.closest('.recipe-sub-nav-btn');
                if (!btn) return;
                
                currentRecipeSubPage = btn.dataset.subpage;
                
                // Update button styles
                recipeSubNav.querySelectorAll('.recipe-sub-nav-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Show/hide sub-pages
                recipeSubPages.forEach(p => p.classList.add('hidden'));
                document.getElementById(`subpage-${currentRecipeSubPage}`).classList.remove('hidden');
                
                // Render content for the activated page
                if (currentRecipeSubPage === 'my-recipes') {
                    renderRecipeList();
                } else if (currentRecipeSubPage === 'meal-planner') {
                    renderMealPlanner();
                }
            });
        }
        
        function renderMealPlanner() {
            weekNavDisplay.textContent = getWeekDisplay(currentWeekStartDate);
            calendarGrid.innerHTML = ''; // Clear existing
            
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(currentWeekStartDate);
                dayDate.setDate(currentWeekStartDate.getDate() + i);
                const dateStr = formatDateString(dayDate);
                const dayName = dayDate.toLocaleDateString(undefined, { weekday: 'short' });
                const dateNum = dayDate.getDate();
                
                const dayPlan = mealPlanData[dateStr] || {};
                
                const dayCard = document.createElement('div');
                dayCard.className = 'bg-white rounded-lg shadow p-3';
                dayCard.innerHTML = `
                    <div class="flex items-center gap-2 mb-3">
                        <span class="text-lg font-bold text-teal-600">${dateNum}</span>
                        <span class="text-sm font-medium text-gray-700">${dayName}</span>
                    </div>
                    <div class="space-y-2">
                        <!-- Breakfast -->
                        <div class="meal-slot border border-dashed border-gray-300 rounded-lg p-2" data-date="${dateStr}" data-meal="breakfast">
                            <span class="text-xs font-medium text-gray-500">Breakfast</span>
                            ${dayPlan.breakfast ? createPlannedMealItem(dayPlan.breakfast.id, dayPlan.breakfast.title, dateStr, 'breakfast') : ''}
                        </div>
                        <!-- Lunch -->
                        <div class="meal-slot border border-dashed border-gray-300 rounded-lg p-2" data-date="${dateStr}" data-meal="lunch">
                            <span class="text-xs font-medium text-gray-500">Lunch</span>
                            ${dayPlan.lunch ? createPlannedMealItem(dayPlan.lunch.id, dayPlan.lunch.title, dateStr, 'lunch') : ''}
                        </div>
                        <!-- Dinner -->
                        <div class="meal-slot border border-dashed border-gray-300 rounded-lg p-2" data-date="${dateStr}" data-meal="dinner">
                            <span class="text-xs font-medium text-gray-500">Dinner</span>
                            ${dayPlan.dinner ? createPlannedMealItem(dayPlan.dinner.id, dayPlan.dinner.title, dateStr, 'dinner') : ''}
                        </div>
                    </div>
                `;
                calendarGrid.appendChild(dayCard);
            }
        }
        
        function createPlannedMealItem(recipeId, recipeTitle, date, meal) {
            return `
            <div class="planned-meal-item bg-teal-50 border border-teal-200 rounded-md p-2 mt-1" data-recipe-id="${recipeId}" data-recipe-title="${recipeTitle}" data-date="${date}" data-meal="${meal}">
                <p class="text-sm font-medium text-teal-800">${recipeTitle}</p>
            </div>
            `;
        }
        
        function handleDragStart(e) {
            if (e.target.classList.contains('recipe-card-draggable')) {
                e.dataTransfer.setData('recipeId', e.target.dataset.recipeId);
                e.dataTransfer.setData('recipeTitle', e.target.dataset.recipeTitle);
                e.target.classList.add('dragging');
            }
        }
        
        function handleDragOver(e) {
            e.preventDefault(); // Necessary to allow drop
            const slot = e.target.closest('.meal-slot');
            if (slot) {
                slot.classList.add('drag-over');
            }
        }
        
        function handleDragLeave(e) {
            const slot = e.target.closest('.meal-slot');
            if (slot) {
                slot.classList.remove('drag-over');
            }
        }
        
        async function handleDrop(e) {
            e.preventDefault();
            const slot = e.target.closest('.meal-slot');
            if (slot) {
                slot.classList.remove('drag-over');
                const recipeId = e.dataTransfer.getData('recipeId');
                const recipeTitle = e.dataTransfer.getData('recipeTitle');
                const date = slot.dataset.date;
                const meal = slot.dataset.meal;
                
                if (recipeId && date && meal) {
                    await saveMealPlan(date, meal, recipeId, recipeTitle);
                }
            }
            document.querySelector('.dragging')?.classList.remove('dragging');
        }
        
        async function saveMealPlan(date, meal, recipeId, recipeTitle) {
            if (!db || !sharedFamilyId) return;
            const docPath = `/artifacts/${appId}/users/${sharedFamilyId}/mealPlan/${date}`;
            const mealData = { id: recipeId, title: recipeTitle };
            try {
                await setDoc(doc(db, docPath), { [meal]: mealData }, { merge: true });
                console.log(`Saved meal plan for ${date}/${meal}`);
            } catch (error) {
                console.error("Error saving meal plan: ", error);
            }
        }

        async function removeMealPlan(date, meal) {
            if (!db || !sharedFamilyId) return;
            const docPath = `/artifacts/${appId}/users/${sharedFamilyId}/mealPlan/${date}`;
            const mealData = { [meal]: null }; // Set to null to remove
            try {
                // We use setDoc with merge to "delete" just that field
                // A better way would be FieldValue.delete() but this is simpler
                // Let's load the doc, remove the key, and save it back
                const docRef = doc(db, docPath);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    let data = docSnap.data();
                    delete data[meal]; // Remove the meal key
                    await setDoc(docRef, data); // Save the object back
                }
                console.log(`Removed meal plan for ${date}/${meal}`);
            } catch (error) {
                console.error("Error removing meal plan: ", error);
            }
        }
        
        function listenToMealPlan() {
            if (!db || !sharedFamilyId) return;
            if (mealPlanListener) mealPlanListener();
            
            const collectionPath = `/artifacts/${appId}/users/${sharedFamilyId}/mealPlan`;
            const mealPlanRef = collection(db, collectionPath);
            mealPlanListener = onSnapshot(mealPlanRef, (snapshot) => {
                console.log(`Received meal plan snapshot with ${snapshot.docs.length} docs.`);
                mealPlanData = {}; // Clear old data
                snapshot.docs.forEach(doc => {
                    mealPlanData[doc.id] = doc.data(); // doc.id is 'YYYY-MM-DD'
                });
                if (currentPage === 'recipes' && currentRecipeSubPage === 'meal-planner') {
                    renderMealPlanner();
                }
            }, (error) => console.error("Error listening to meal plan: ", error));
        }

        function openPlannedMealModal(date, meal, recipeId, recipeTitle) {
            viewPlannedMealTitle.textContent = recipeTitle;
            viewRecipeDetailsBtn.dataset.recipeId = recipeId;
            removePlannedMealBtn.dataset.date = date;
            removePlannedMealBtn.dataset.meal = meal;
            viewPlannedMealModal.classList.remove('hidden');
        }
        
        function parseIngredients(text) {
            if (!text) return [];
            return text.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
        }
        
        async function generateShoppingList() {
            if (recipesData.length === 0) {
                shoppingListContent.innerHTML = '<p>No recipes found.</p>';
                shoppingListModal.classList.remove('hidden');
                return;
            }
            
            const allIngredients = new Set();
            const weekDates = [];
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(currentWeekStartDate);
                dayDate.setDate(currentWeekStartDate.getDate() + i);
                weekDates.push(formatDateString(dayDate));
            }
            
            for (const date of weekDates) {
                const dayPlan = mealPlanData[date];
                if (dayPlan) {
                    for (const meal of ['breakfast', 'lunch', 'dinner']) {
                        if (dayPlan[meal]) {
                            const recipeId = dayPlan[meal].id;
                            const recipeDoc = recipesData.find(doc => doc.id === recipeId);
                            if (recipeDoc) {
                                const ingredients = parseIngredients(recipeDoc.data().ingredients);
                                ingredients.forEach(ing => allIngredients.add(ing));
                            }
                        }
                    }
                }
            }
            
            if (allIngredients.size === 0) {
                shoppingListContent.innerHTML = '<p>No meals planned for this week.</p>';
            } else {
                shoppingListContent.innerHTML = `<ul>${[...allIngredients].map(item => `<li>${item}</li>`).join('')}</ul>`;
            }
            shoppingListModal.classList.remove('hidden');
        }

        // --- END MEAL PLANNER FUNCTIONS ---


        // (listenToTriedFoods is unchanged)
        function listenToTriedFoods() {
            if (!db || !sharedFamilyId) return; 
            if (triedFoodsListener) triedFoodsListener();
            const collectionPath = `/artifacts/${appId}/users/${sharedFamilyId}/triedFoods`;
            const triedFoodsRef = collection(db, collectionPath);
            triedFoodsListener = onSnapshot(triedFoodsRef, (snapshot) => {
                console.log(`Received snapshot with ${snapshot.docs.length} docs.`);
                triedFoodsData = snapshot.docs;
                const triedCount = triedFoodsData.length;
                progressText.textContent = `${triedCount} / ${totalFoodCount}`;
                progressBar.style.width = `${(triedCount / totalFoodCount) * 100}%`;
                if (currentPage === 'log') renderSummaryList(triedFoodsData);
                if (currentPage === 'tracker') renderFoodGrid();
                if (currentPage === 'ideas') displayRecommendations();
                updateFoodGridUI(triedFoodsData);
            }, (error) => console.error("Error listening to tried foods: ", error));
        }

        // (updateFoodGridUI is unchanged)
        function updateFoodGridUI(triedDocs) {
             const triedSet = new Set(triedDocs.map(doc => doc.id));
             document.querySelectorAll('#food-grid-container .food-card').forEach(card => {
                card.classList.toggle('is-tried', triedSet.has(card.dataset.foodName));
            });
            lucide.createIcons();
        }

        // (openModal is unchanged)
        async function openModal(foodName) {
            currentFoodName = foodName;
            const food = allFoods.flatMap(c => c.items).find(f => f.name === foodName);
            modalFoodName.textContent = `${food ? food.emoji : ''} ${foodName}`;
            showGuideBtn.dataset.foodName = foodName;
            modalForm.reset();
            feedingDate.valueAsDate = new Date(); 
            reactionHidden.value = '';
            biteHidden.value = '';
            document.querySelectorAll('.reaction-btn, .bite-btn').forEach(btn => btn.classList.remove('modal-btn-selected'));
            if (db && sharedFamilyId) {
                const docPath = `/artifacts/${appId}/users/${sharedFamilyId}/triedFoods/${foodName}`;
                const docRef = doc(db, docPath);
                try {
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        reactionHidden.value = data.reaction;
                        let reactionBtn = document.querySelector(`.reaction-btn[data-value="${data.reaction}"]`);
                        if (!reactionBtn) {
                            if (data.reaction <= 2) reactionBtn = document.querySelector(`.reaction-btn[data-value="1"]`);
                            else if (data.reaction <= 4) reactionBtn = document.querySelector(`.reaction-btn[data-value="3"]`);
                            else if (data.reaction <= 6) reactionBtn = document.querySelector(`.reaction-btn[data-value="5"]`);
                            else reactionBtn = document.querySelector(`.reaction-btn[data-value="7"]`);
                        }
                        if (reactionBtn) reactionBtn.classList.add('modal-btn-selected');
                        feedingDate.value = data.date || new Date().toISOString().split('T')[0];
                        const biteValue = data.moreThanOneBite ? 'yes' : 'no';
                        biteHidden.value = biteValue;
                        const biteBtn = document.querySelector(`.bite-btn[data-value="${biteValue}"]`);
                        if (biteBtn) biteBtn.classList.add('modal-btn-selected');
                    }
                } catch (error) { console.error("Error fetching food data: ", error); }
            }
            modal.classList.remove('hidden');
            lucide.createIcons();
        }

        // (closeModal is unchanged)
        function closeModal() {
            modal.classList.add('hidden');
            currentFoodName = null;
            modalForm.reset();
            reactionHidden.value = '';
            biteHidden.value = '';
            document.querySelectorAll('.reaction-btn, .bite-btn').forEach(btn => btn.classList.remove('modal-btn-selected'));
        }

        // (handleFormSubmit is unchanged)
        async function handleFormSubmit(e) {
            e.preventDefault();
            if (!db || !sharedFamilyId || !currentFoodName) return; 
            if (!reactionHidden.value || !biteHidden.value) return;
            const dataToSave = {
                reaction: parseInt(reactionHidden.value, 10),
                date: feedingDate.value,
                moreThanOneBite: biteHidden.value === 'yes',
                tried: true
            };
            const docPath = `/artifacts/${appId}/users/${sharedFamilyId}/triedFoods/${currentFoodName}`;
            try {
                await setDoc(doc(db, docPath), dataToSave);
                closeModal();
            } catch (error) { console.error("Error saving document: ", error); }
        }

        // *** MODIFIED switchPage ***
        function switchPage(pageId) {
            currentPage = pageId;
            pages.forEach(page => page.classList.add('hidden'));
            const newPage = document.getElementById(`page-${pageId}`);
            if (newPage) newPage.classList.remove('hidden');
            else {
                document.getElementById('page-tracker').classList.remove('hidden');
                currentPage = 'tracker';
            }
            navButtons.forEach(btn => {
                const isCurrent = btn.dataset.page === currentPage;
                btn.classList.toggle('text-teal-600', isCurrent);
                btn.classList.toggle('text-gray-500', !isCurrent);
                btn.classList.toggle('hover:text-gray-700', !isCurrent);
            });
            
            // Render content based on the new page
            if (currentPage === 'log') renderSummaryList(triedFoodsData);
            else if (currentPage === 'ideas') displayRecommendations();
            else if (currentPage === 'learn' && !researchAccordionRendered) {
                renderResearchAccordion();
                researchAccordionRendered = true;
            } else if (currentPage === 'tracker') renderFoodGrid();
            else if (currentPage === 'recipes') {
                // Check which sub-page is active
                if (currentRecipeSubPage === 'my-recipes') {
                    renderRecipeList();
                } else if (currentRecipeSubPage === 'meal-planner') {
                    renderMealPlanner();
                }
            }
            
            lucide.createIcons();
        }

        // (showHowToServeGuide, closeServeGuideModal, exportToCSV, exportToPDF, createAccordionItem, renderResearchAccordion, calculateAge, displayRecommendations, loadUserProfile, saveBabyProfile, savePediatricianApproval are unchanged)
        // ...
        function showHowToServeGuide(foodName) {
            const food = allFoods.flatMap(c => c.items).find(f => f.name === foodName);
            serveGuideFoodName.textContent = `${food ? food.emoji : ''} ${foodName}`;
            
            const guide = foodGuideData[foodName];
            if (guide) {
                let riskHtml = '';
                if (guide.allergyRisk.toLowerCase().includes('high')) {
                    riskHtml += `<p class="mb-4 p-3 bg-red-50 border border-red-200 rounded-md"><strong>Allergy Risk: ${guide.allergyRisk}</strong></p>`;
                }
                if (guide.chokingRisk.toLowerCase().includes('high')) {
                    riskHtml += `<p class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-md"><strong>Choking Risk: ${guide.chokingRisk}</strong></p>`;
                }
                
                serveGuideContent.innerHTML = `
                    ${riskHtml}
                    ${guide.serve6to8}
                    ${guide.serve9to12}
                `;
            } else {
                serveGuideContent.innerHTML = `<p class="text-center text-gray-500 py-6">A detailed "How to Serve" guide for this food is coming soon!</p>`;
            }
            
            serveGuideModal.classList.remove('hidden');
            lucide.createIcons();
        }
        
        function closeServeGuideModal() {
            serveGuideModal.classList.add('hidden');
        }
        
        function exportToCSV() {
            if (triedFoodsData.length === 0) return;
            let csvContent = "data:text/csv;charset=utf-8,Food Name,Date,Reaction (1-7),More than 1 Bite?\n";
            triedFoodsData.forEach(doc => {
                const data = doc.data();
                csvContent += [ doc.id, data.date, data.reaction, data.moreThanOneBite ? "Yes" : "No" ].join(",") + "\n";
            });
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "tiny_tastes_summary.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportToPDF() {
            if (triedFoodsData.length === 0) return;
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const tableColumns = ["Food Name", "Date", "Reaction (1-7)", "More than 1 Bite?"];
                const tableRows = triedFoodsData.map(doc => {
                    const data = doc.data();
                    return [ doc.id, data.date, data.reaction, data.moreThanOneBite ? "Yes" : "No" ];
                });
                doc.autoTable({ head: [tableColumns], body: tableRows, startY: 20 });
                doc.text("Tiny Tastes Tracker Summary", 14, 15);
                doc.save("tiny_tastes_summary.pdf");
            } catch (error) { console.error("Error exporting PDF: ", error); }
        }

        function createAccordionItem(id, title, icon, content, isOpen = false) {
            const item = document.createElement('div');
            item.className = `accordion-item bg-white shadow-sm rounded-lg border border-gray-200 ${isOpen ? 'is-open' : ''}`;
            item.innerHTML = `
                <button class="accordion-toggle flex justify-between items-center w-full p-4 text-left">
                    <span class="flex items-center gap-3"><i data-lucide="${icon}" class="w-5 h-5 text-teal-600"></i><span class="text-md font-medium text-gray-700">${title}</span></span>
                    <i data-lucide="chevron-down" class="w-5 h-5 text-gray-400 accordion-arrow transition-transform"></i>
                </button>
                <div class="accordion-content p-4 pt-0 text-gray-600 text-sm"><div class="prose prose-sm max-w-none">${content}</div></div>`;
            return item;
        }

        function renderResearchAccordion() {
            researchAccordionContainer.innerHTML = '';
            researchData.forEach((item, index) => {
                researchAccordionContainer.appendChild(createAccordionItem(`research-${index}`, item.title, item.icon, item.content, index === 0));
            });
            lucide.createIcons();
        }

        function calculateAge(dateString) {
            const birthDate = new Date(dateString), today = new Date();
            let years = today.getFullYear() - birthDate.getFullYear(), months = today.getMonth() - birthDate.getMonth(), days = today.getDate() - birthDate.getDate();
            if (days < 0) { months--; days += new Date(today.getFullYear(), today.getMonth(), 0).getDate(); }
            if (months < 0) { years--; months += 12; }
            const totalMonths = (years * 12) + months;
            let ageKey = '12_plus';
            if (totalMonths < 6) ageKey = 'too_young';
            else if (totalMonths === 6) ageKey = '6_months';
            else if (totalMonths >= 7 && totalMonths <= 8) ageKey = '7_8_months';
            else if (totalMonths >= 9 && totalMonths <= 11) ageKey = '9_11_months';
            let ageString = '';
            if (years > 0) ageString += `${years} year${years > 1 ? 's' : ''}, `;
            ageString += `${months} month${months !== 1 ? 's' : ''}, and ${days} day${days !== 1 ? 's' : ''}`;
            return { ageString, ageKey, totalMonths };
        }

        function displayRecommendations() {
            if (!babyBirthDate) {
                recommendationsContainer.innerHTML = `<p class="text-gray-500 text-center py-4">Please enter your baby's birth date above to see recommendations.</p>`;
                ageDisplayContainer.classList.add('hidden');
                return;
            }
            const { ageString, ageKey } = calculateAge(babyBirthDate);
            if (ageKey === 'too_young' && !pediatricianApproved) {
                ageDisplayContainer.classList.add('hidden');
                recommendationsContainer.innerHTML = `
                    <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-md">
                        <h3 class="text-lg font-semibold text-yellow-800">Note: Baby is Under 6 Months</h3>
                        <p class="text-yellow-700 mt-2">${recommendationData.too_young.message}</p>
                        <p class="text-gray-700 font-medium mt-4">Has your pediatrician specifically approved starting solids early?</p>
                        <div class="mt-3"><button id="approve-early-start-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">Yes, we are approved</button></div>
                    </div>`;
                return;
            }
            const displayName = babyName ? `${babyName}'s Age:` : "Baby's Age:";
            ageDisplay.innerHTML = `<span class="font-normal">${displayName}</span> <span class="font-bold">${ageString}</span>`;
            ageDisplayContainer.classList.remove('hidden');
            recommendationsContainer.innerHTML = '';
            const triedFoodSet = new Set(triedFoodsData.map(doc => doc.id));
            Object.keys(recommendationData).forEach(key => {
                if (key === 'too_young') return;
                const stage = recommendationData[key];
                const stageFoods = stage.foods.map(fname => allFoods.flatMap(c => c.items).find(f => f.name === fname)).filter(Boolean);
                const triedInStage = stageFoods.filter(f => triedFoodSet.has(f.name));
                const toTryInStage = stageFoods.filter(f => !triedFoodSet.has(f.name));
                let contentHtml = `<p class="text-sm text-gray-600 mb-4">${stage.message}</p>`;
                if (toTryInStage.length > 0) {
                    contentHtml += `<h4 class="text-md font-medium text-green-700 mb-3">New Foods to Try:</h4><div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 sm:gap-4">${toTryInStage.map(food => createFoodCard(food, false).outerHTML).join('')}</div>`;
                } else if (stage.foods.length > 0) {
                    contentHtml += `<p class="text-green-700 font-medium py-4">Congratulations! You've tried all the recommended foods for this stage!</p>`;
                }
                if (triedInStage.length > 0) {
                    contentHtml += `<h4 class="text-md font-medium text-gray-500 mt-6 mb-3">Foods Tried This Stage:</h4><div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 sm:gap-4">${triedInStage.map(food => createFoodCard(food, true).outerHTML).join('')}</div>`;
                }
                const currentStageKey = (ageKey === 'too_young' && pediatricianApproved) ? '6_months' : ageKey;
                const isOpen = (key === currentStageKey);
                recommendationsContainer.appendChild(createAccordionItem(key, `${stage.title} (${triedInStage.length}/${stageFoods.length} tried)`, 'star', contentHtml, isOpen));
            });
            lucide.createIcons();
        }

        async function loadUserProfile() {
            if (!db || !sharedFamilyId) return; 
            const docPath = `/artifacts/${appId}/users/${sharedFamilyId}/profile/data`; 
            try {
                const docSnap = await getDoc(doc(db, docPath));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.birthDate) {
                        babyBirthDate = data.birthDate;
                        birthDateInput.value = babyBirthDate;
                    }
                    if (data.pediatricianApproved) pediatricianApproved = data.pediatricianApproved;
                    if (data.babyName) { 
                        babyName = data.babyName;
                        babyNameInput.value = babyName;
                        profileDisplay.textContent = `Hi, ${babyName}! üëã`;
                        profileDisplay.classList.remove('hidden');
                        headerSubtitle.innerHTML = `Tracking for: <span class="font-semibold text-teal-600">${babyName}</span>`;
                    } else {
                        profileDisplay.classList.add('hidden');
                        headerSubtitle.innerHTML = `Family ID: <code class="font-mono bg-gray-100 p-1 rounded">${sharedFamilyId}</code>`;
                    }
                } else {
                    headerSubtitle.innerHTML = `Family ID: <code class="font-mono bg-gray-100 p-1 rounded">${sharedFamilyId}</code>`;
                }
            } catch (error) { console.error("Error loading user profile: ", error); }
            if(currentPage === 'ideas') displayRecommendations();
        }

        async function saveBabyProfile() {
            if (!db || !sharedFamilyId) return; 
            const newBirthDate = birthDateInput.value;
            const newBabyName = babyNameInput.value;
            const dataToSave = { pediatricianApproved: pediatricianApproved };
            if (newBirthDate) dataToSave.birthDate = newBirthDate;
            if (newBabyName) dataToSave.babyName = newBabyName;
            const docPath = `/artifacts/${appId}/users/${sharedFamilyId}/profile/data`;
            try {
                await setDoc(doc(db, docPath), dataToSave, { merge: true });
                if (newBirthDate) babyBirthDate = newBirthDate;
                if (newBabyName) {
                    babyName = newBabyName;
                    profileDisplay.textContent = `Hi, ${babyName}! üëã`;
                    profileDisplay.classList.remove('hidden');
                    headerSubtitle.innerHTML = `Tracking for: <span class="font-semibold text-teal-600">${babyName}</span>`;
                } else if (!newBabyName) {
                     babyName = null;
                    profileDisplay.classList.add('hidden');
                    headerSubtitle.innerHTML = `Family ID: <code class="font-mono bg-gray-100 p-1 rounded">${sharedFamilyId}</code>`;
                }
                console.log("Saved baby profile.");
                displayRecommendations();
            } catch (error) { console.error("Error saving user profile: ", error); }
        }
        
        async function savePediatricianApproval(isApproved) {
            if (!db || !sharedFamilyId) return; 
            const docPath = `/artifacts/${appId}/users/${sharedFamilyId}/profile/data`;
            try {
                await setDoc(doc(db, docPath), { pediatricianApproved: isApproved }, { merge: true });
                pediatricianApproved = isApproved;
                displayRecommendations();
            } catch (error) { console.error("Error saving approval status: ", error); }
        }

        // --- AUTH & LOGIN FUNCTIONS ---
        
        function checkFamilyId() {
            const storedFamilyId = localStorage.getItem('familyId');
            if (storedFamilyId) {
                sharedFamilyId = storedFamilyId;
                console.log(`Found Family ID: ${sharedFamilyId}`);
                familyIdModal.classList.add('hidden');
                // Load ALL data for this family
                loadUserProfile();
                listenToTriedFoods();
                listenToRecipes();
                listenToMealPlan(); // NEW
            } else {
                console.log("No Family ID found. Showing login modal.");
                familyIdModal.classList.remove('hidden');
            }
        }

        function handleFamilyIdJoin() {
            const newId = familyIdInput.value.trim();
            if (newId) {
                localStorage.setItem('familyId', newId);
                checkFamilyId(); 
            } else {
                console.log("Please enter a valid Family ID.");
            }
        }

        function handleLogOut() {
            localStorage.removeItem('familyId');
            if (triedFoodsListener) triedFoodsListener(); 
            if (recipesListener) recipesListener();
            if (mealPlanListener) mealPlanListener(); // NEW
            
            triedFoodsData = [];
            recipesData = [];
            mealPlanData = {}; // NEW
            babyBirthDate = null;
            babyName = null;
            pediatricianApproved = false;
            sharedFamilyId = null;
            
            location.reload();
        }

        async function initializeFirebase() {
            if (!firebaseConfig.apiKey || !appId || appId === "YOUR_PROJECT_ID_GOES_HERE") {
                headerSubtitle.textContent = "Error: App is not configured.";
                console.error("Firebase config or appId is missing. Please edit the HTML file and add them.");
                
                document.querySelector('main').innerHTML = `
                    <div class="p-6">
                        <h1 class="text-2xl font-bold text-red-600">App Not Configured</h1>
                        <p class="mt-4 text-gray-700">This app cannot connect to its database. If you are the developer, you must:</p>
                        <ol class="list-decimal list-inside mt-2 space-y-1 text-gray-600">
                            <li>Create a Firebase project.</li>
                            <li>Enable Firestore and Anonymous Authentication.</li>
                            <li>Copy the <code class="bg-gray-200 p-1 rounded">firebaseConfig</code> object and <code class="bg-gray-200 p-1 rounded">projectId</code> into the HTML file.</li>
                        </ol>
                    </div>
                `;
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug');

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log(`Anonymous auth successful: ${user.uid}`);
                        checkFamilyId();
                    } else {
                        console.log("No user signed in. Attempting anonymous sign in...");
                        sharedFamilyId = null;
                        if (triedFoodsListener) triedFoodsListener(); 
                        if (recipesListener) recipesListener();
                        if (mealPlanListener) mealPlanListener(); // NEW
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Error during anonymous sign-in: ", error);
                            headerSubtitle.textContent = "Error: Auth failed";
                        }
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase: ", error);
                headerSubtitle.textContent = "Error: Init failed";
            }
        }

        // --- Event Listeners ---
        // Family ID
        joinFamilyBtn.addEventListener('click', handleFamilyIdJoin);
        logOutBtn.addEventListener('click', handleLogOut);
        
        // Food Log Modal
        modalCloseBtn.addEventListener('click', closeModal);
        modalCancelBtn.addEventListener('click', closeModal);
        modalForm.addEventListener('submit', handleFormSubmit);
        
        // "How to Serve" Modal
        showGuideBtn.addEventListener('click', () => showHowToServeGuide(showGuideBtn.dataset.foodName));
        serveGuideCloseBtn.addEventListener('click', closeServeGuideModal);
        
        // Recipe Modals
        showAddRecipeModalBtn.addEventListener('click', () => addRecipeModal.classList.remove('hidden'));
        addRecipeCloseBtn.addEventListener('click', () => addRecipeModal.classList.add('hidden'));
        addRecipeCancelBtn.addEventListener('click', () => addRecipeModal.classList.add('hidden'));
        addRecipeForm.addEventListener('submit', handleAddRecipe);
        viewRecipeCloseBtn.addEventListener('click', () => viewRecipeModal.classList.add('hidden'));
        
        // View Recipe from Recipe List
        recipeListContainer.addEventListener('click', (e) => {
            const btn = e.target.closest('.recipe-card-draggable'); // Click on card
            if(btn) openViewRecipeModal(btn.dataset.recipeId);
        });
        
        // View Recipe from Meal Plan
        viewRecipeDetailsBtn.addEventListener('click', (e) => {
            openViewRecipeModal(e.target.dataset.recipeId);
            viewPlannedMealModal.classList.add('hidden');
        });
        
        // --- NEW MEAL PLANNER LISTENERS ---
        
        // Recipe Sub-tab navigation
        initializeRecipePageTabs();
        
        // Week Navigation
        prevWeekBtn.addEventListener('click', () => {
            currentWeekStartDate.setDate(currentWeekStartDate.getDate() - 7);
            renderMealPlanner();
        });
        nextWeekBtn.addEventListener('click', () => {
            currentWeekStartDate.setDate(currentWeekStartDate.getDate() + 7);
            renderMealPlanner();
        });
        todayBtn.addEventListener('click', () => {
            currentWeekStartDate = getStartOfWeek(new Date());
            renderMealPlanner();
        });
        
        // Drag/Drop Listeners
        recipeListContainer.addEventListener('dragstart', handleDragStart);
        calendarGrid.addEventListener('dragover', handleDragOver);
        calendarGrid.addEventListener('dragleave', handleDragLeave);
        calendarGrid.addEventListener('drop', handleDrop);

        
        // Click on a planned meal
        calendarGrid.addEventListener('click', (e) => {
            const item = e.target.closest('.planned-meal-item');
            if (item) {
                openPlannedMealModal(item.dataset.date, item.dataset.meal, item.dataset.recipeId, item.dataset.recipeTitle);
            }
        });
        
        // Remove planned meal
        removePlannedMealBtn.addEventListener('click', async (e) => {
            const { date, meal } = e.target.dataset;
            await removeMealPlan(date, meal);
            viewPlannedMealModal.classList.add('hidden');
        });
        viewPlannedMealCloseBtn.addEventListener('click', () => viewPlannedMealModal.classList.add('hidden'));
        
        // Shopping List
        generateShoppingListBtn.addEventListener('click', generateShoppingList);
        shoppingListCloseBtn.addEventListener('click', () => shoppingListModal.classList.add('hidden'));

        // --- END NEW MEAL PLANNER LISTENERS ---

        // Reaction/Bite Buttons
        reactionBtnGroup.addEventListener('click', (e) => {
            const btn = e.target.closest('.reaction-btn');
            if (!btn) return;
            reactionBtnGroup.querySelectorAll('.reaction-btn').forEach(b => b.classList.remove('modal-btn-selected'));
            btn.classList.add('modal-btn-selected');
            reactionHidden.value = btn.dataset.value;
        });
        biteBtnGroup.addEventListener('click', (e) => {
            const btn = e.target.closest('.bite-btn');
            if (!btn) return;
            biteBtnGroup.querySelectorAll('.bite-btn').forEach(b => b.classList.remove('modal-btn-selected'));
            btn.classList.add('modal-btn-selected');
            biteHidden.value = btn.dataset.value;
        });
        
        // Food Grid Click
        foodGridContainer.addEventListener('click', (e) => {
            const card = e.target.closest('.food-card');
            if (card && card.dataset.foodName) openModal(card.dataset.foodName);
        });
        recommendationsContainer.addEventListener('click', (e) => {
             const card = e.target.closest('.food-card');
            if (card && card.dataset.foodName) openModal(card.dataset.foodName);
        });
        
        // Nav & Accordions
        navButtons.forEach(btn => btn.addEventListener('click', () => switchPage(btn.dataset.page)));
        document.body.addEventListener('click', (e) => {
            const toggle = e.target.closest('.accordion-toggle');
            if (toggle) toggle.closest('.accordion-item').classList.toggle('is-open');
        });
        
        // Filter
        document.getElementById('filter-btn-group').addEventListener('click', (e) => {
            const btn = e.target.closest('.filter-btn');
            if (!btn) return;
            currentFilter = btn.dataset.filter;
            document.querySelectorAll('#filter-btn-group .filter-btn').forEach(b => {
                b.classList.remove('bg-teal-600', 'text-white');
                b.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
            });
            btn.classList.add('bg-teal-600', 'text-white');
            btn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-30all');
            renderFoodGrid();
        });
        
        // Exports & Profile
        exportCsvBtn.addEventListener('click', exportToCSV);
        exportPdfBtn.addEventListener('click', exportToPDF);
        saveProfileBtn.addEventListener('click', saveBabyProfile);
        recommendationsContainer.addEventListener('click', (e) => {
            if (e.target.id === 'approve-early-start-btn') savePediatricianApproval(true);
        });

        // --- App Initialization ---
        switchPage('tracker');
        initializeFirebase();
        lucide.createIcons();
    </script>
</body>
</html>
